<html>

<head>
    <!-- https://codewithmark.com/easily-create-file-upload-progress-bar-using-only-javascript -->\
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body onLoad="loaded();"
    style='background-color: #1a1e15;margin: 1.8em; font-size: 20px;font-family:  Helvetica, Arial, sans-serif;color: #f7f7e6;'>
    <script type='text/javascript'>
        function loaded() {
            $.ajax({
                url: '/releases',
                dataType: 'json',
                async: false,
                success: function (data, textStatus, jqXHR) {
                    $.each(data.releases, function (i, release) {

                        $('#sel_releases').append($('<option>', {
                            value: release[0],
                            text: release[0]
                        }));

                    })
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log("Cannot get releases", textStatus, jqXHR.status);
                }
            });
        };
        function _(el) { return document.getElementById(el); }
        function upload() { var file = _('firmware').files[0]; var formdata = new FormData(); formdata.append('firmware', file); var ajax = new XMLHttpRequest(); ajax.upload.addEventListener('progress', progressHandler, false); ajax.addEventListener('load', completeHandler, false); ajax.addEventListener('error', errorHandler, false); ajax.addEventListener('abort', abortHandler, false); ajax.open('POST', 'doUpdate'); ajax.send(formdata); }
        function progressHandler(event) { _('loadedtotal').innerHTML = 'Uploaded ' + event.loaded + ' bytes of ' + event.total; var percent = (event.loaded / event.total) * 100; _('progressBar').value = Math.round(percent); _('status').innerHTML = Math.round(percent) + '&percnt; uploaded... please wait'; }
        function reloadAdmin() { window.location.href = '/#admin'; }
        function completeHandler(event) { _('status').innerHTML = event.target.responseText; _('progressBar').value = 0; setTimeout(reloadAdmin, 20000); }
        function errorHandler(event) { _('status').innerHTML = 'Upload Failed'; }
        function abortHandler(event) { _('status').innerHTML = 'Upload Aborted'; }    </script>
    <h1>Firmware and filesystem update</h1>
    <p><a style="cursor:pointer; border-bottom: 4px solid #f3f300;color:white;text-decoration:none;" ;
            href="/export-config?format=file">Backup configuration</a> before starting upgrade.</p>
    <form method="post" action="/update"> <select name="release" id="sel_releases"></select>
        <input type="submit"  name="Update">
    </form>
    <p>Update firmware first and filesystem (littlefs.bin) after that (if required). After update check version data
        from the bottom of the page - update could be succeeded even if you get an error message.</p>
    <form method='post' enctype='multipart/form-data'> <input type='file' name='firmware' id='firmware'
            onchange='upload()'><br>
        <progress id='progressBar' value='0' max='100' style='width:250px;'></progress>

        <h2 id='status'></h2>
        <p id='loadedtotal'></p>
    </form> <br>Current versions:, Filesystem
    </i> </ body>
    </ html>